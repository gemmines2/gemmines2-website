<!doctype html>
list.forEach(p=>{
const el=document.createElement('div');el.className='product';
el.innerHTML=`
<img src="${p.img}" alt="${p.name}" />
<h3 contenteditable="${SITE.ownerEditMode}" data-id="${p.id}" class="p-name">${p.name}</h3>
<p contenteditable="${SITE.ownerEditMode}" data-id="${p.id}" class="p-desc">${p.desc}</p>
<div class="meta">
<div class="price">$${p.price}</div>
<div>
<button class="buy" data-id="${p.id}">Buy</button>
</div>
</div>`;
grid.appendChild(el);
})
}


// save inline edits to PRODUCTS array (ownerEditMode)
function attachInlineSave(){if(!SITE.ownerEditMode) return;grid.addEventListener('blur',e=>{
const t=e.target;if(t.matches('[data-id].p-desc')||t.matches('[data-id].p-name')){
const id=t.dataset.id;const prod=PRODUCTS.find(x=>x.id===id);if(prod){if(t.classList.contains('p-name')) prod.name=t.innerText.trim(); else prod.desc=t.innerText.trim();}
}
},true)}


// ----- SEARCH -----
document.getElementById('quick-search').addEventListener('input',e=>{const q=e.target.value.trim().toLowerCase();if(!q) renderProducts(); else{
const filtered=PRODUCTS.filter(p=> (p.name+p.desc).toLowerCase().includes(q)); renderProducts(filtered);
}});
document.getElementById('clear-search').addEventListener('click',()=>{document.getElementById('quick-search').value='';renderProducts();});


// ----- NAV -----
document.querySelectorAll('[data-nav]').forEach(btn=>btn.addEventListener('click',()=>{const id=btn.dataset.nav;showPage(id);}));
function showPage(id){document.querySelectorAll('.page').forEach(s=>s.classList.remove('active'));const el=document.getElementById(id);if(el) el.classList.add('active');if(id==='products') renderProducts();if(id==='checkout') renderCheckout();scrollToTop();}
function scrollToTop(){window.scrollTo({top:0,behavior:'smooth'})}


// ----- CART UI -----
document.getElementById('cart-toggle').addEventListener('click',()=>{const c=document.getElementById('cart');c.style.display=c.style.display==='none'?'block':'none';renderCartPanel();});
function renderCartCount(){const items=cartItemsDetailed().reduce((s,i)=>s+i.qty,0);document.getElementById('cart-count').innerText=items}


function renderCartPanel(){const c=document.getElementById('cart');const container=document.getElementById('cart-items');const items=cartItemsDetailed();container.innerHTML='';let total=0;items.forEach(it=>{total+=it.qty*it.price;const row=document.createElement('div');row.className='cart-item';row.innerHTML=`<img src="${it.img}" alt="${it.name}"/><div style="flex:1"><div class="title">${it.name}</div><div style="color:var(--muted);font-size:0.9rem">$${it.price} × <input style="width:44px;border-radius:6px;padding:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit" type="number" value="${it.qty}" min="1" data-cart-id="${it.id}" class="qty-input" /></div></div><button data-remove="${it.id}" style="background:transparent;border:none;color:var(--muted);font-weight:700;cursor:pointer">Remove</button>`;container.appendChild(row)});
document.getElementById('cart-total').innerText='$'+(total.toFixed(2));
document.getElementById('cart').style.display=items.length? 'block':'none';
// attach qty listeners
container.querySelectorAll('.qty-input').forEach(inp=>inp.addEventListener('change',e=>{const id=e.target.dataset.cartId;const v=parseInt(e.target.value)||1;setQty(id,v);}));
container.querySelectorAll('[data-remove]').forEach(b=>b.addEventListener('click',e=>{removeFromCart(b.dataset.remove);}));
renderCartCount();
}


// when clicking buy
document.addEventListener('click',e=>{if(e.target.matches('.buy')){const id=e.target.dataset.id;addToCart(id);}});


// checkout
document.getElementById('go-checkout').addEventListener('click',()=>{showPage('checkout');});
function renderCheckout(){const items=cartItemsDetailed();const container=document.getElementById('cart-summary');if(items.length===0){container.innerHTML='<div style="color:var(--muted)">Your cart is empty.</div>';return}
let html='<div style="background:rgba(255,255,255,0.02);padding:12px;border-radius:8px">';let total=0;items.forEach(it=>{html+=`<div style="display:flex;justify-content:space-between;padding:6px 0"><div>${it.name} × ${it.qty}</div><div>$${(it.price*it.qty).toFixed(2)}</div></div>`;total+=it.price*it.qty});html+=`<hr style="border:none;border-top:1px dashed rgba(255,255,255,0.04);margin:8px 0"/><div style="display:flex;justify-content:space-between;font-weight:800">Total<div>$${total.toFixed(2)}</div></div></div>`;container.innerHTML=html;document.getElementById('cart-total').innerText='$'+total.toFixed(2);}


document.getElementById('place-order').addEventListener('click',()=>{
const name=document.getElementById('c-name').value.trim();const email=document.getElementById('c-email').value.trim();const phone=document.getElementById('c-phone').value.trim();const addr=document.getElementById('c-address').value.trim();
if(!name||!email||!phone||!addr){alert('Please complete contact & shipping information.');return}
const order={id:'ORD-'+Date.now(),items:cartItemsDetailed(),contact:{name,email,phone,addr},total:document.getElementById('cart-total').innerText};
// In a real site: send order to server / email / payment gateway. Here we simulate success.
console.log('ORDER',order);
localStorage.removeItem(CART_KEY);renderCartPanel();renderCartCount();
document.getElementById('order-success').style.display='block';
// show order success and clear checkout form
document.getElementById('c-name').value='';document.getElementById('c-email').value='';document.getElementById('c-phone').value='';document.getElementById('c-address').value='';
document.getElementById('cart-summary').innerHTML='';
});


// remove item helper exposed for debugging
window.__addToCart=addToCart;


// small helpers
function init(){renderProducts();attachInlineSave();renderCartPanel();document.getElementById('year').innerText=new Date().getFullYear();}
init();
</script>
</body>
</html>
